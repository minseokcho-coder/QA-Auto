name: QA ì •ê¸° í…ŒìŠ¤íŠ¸ (ì˜¤ì „ 10ì‹œ)

on:
  schedule:
    - cron: '50 0 * * 1-5'  # í‰ì¼ ì˜¤ì „ 9:50 KST (UTC 0:50)
  workflow_dispatch:

env:
  QA_BASE_URL: https://qa.hiddenmoney.co.kr
  SLACK_CHANNEL_ID: C0ACQMG41CY

jobs:
  daily-test:
    name: ğŸ“… ì¼ì¼ QA í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest

    steps:
      - name: ì‹œì‘ ì‹œê°„ ê¸°ë¡
        run: |
          echo "ğŸ• í…ŒìŠ¤íŠ¸ ì‹œì‘: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S') KST"

      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Chrome ë¸Œë¼ìš°ì € ì„¤ì¹˜
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          pip install selenium webdriver-manager pytest pytest-html pytest-json-report requests python-dotenv

      - name: í…ŒìŠ¤íŠ¸ í™˜ê²½ ì¤€ë¹„
        run: |
          mkdir -p qa/reports/screenshots

      - name: ê°„ë‹¨ ì—°ê²° í…ŒìŠ¤íŠ¸
        env:
          QA_HEADLESS: 'true'
        run: |
          python << 'EOF'
          import requests
          import json
          from datetime import datetime

          url = "https://qa.hiddenmoney.co.kr"
          results = {"summary": {"total": 1, "passed": 0, "failed": 0, "skipped": 0}, "tests": []}

          try:
              response = requests.get(url, timeout=30)
              if response.status_code == 200:
                  print(f"âœ“ {url} - ì—°ê²° ì„±ê³µ (status: {response.status_code})")
                  results["summary"]["passed"] = 1
                  results["tests"].append({"name": "connection_test", "outcome": "passed"})
              else:
                  print(f"âœ— {url} - ì‘ë‹µ ì½”ë“œ: {response.status_code}")
                  results["summary"]["failed"] = 1
                  results["tests"].append({"name": "connection_test", "outcome": "failed"})
          except Exception as e:
              print(f"âœ— {url} - ì—°ê²° ì‹¤íŒ¨: {e}")
              results["summary"]["failed"] = 1
              results["tests"].append({"name": "connection_test", "outcome": "failed", "error": str(e)})

          # JSON ë¦¬í¬íŠ¸ ì €ì¥
          with open("qa/reports/daily-report.json", "w") as f:
              json.dump(results, f, indent=2)

          print(f"\nğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼: {results['summary']}")
          EOF

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: daily-test-${{ github.run_number }}
          path: qa/reports/
          retention-days: 14

      - name: Slack ë¦¬í¬íŠ¸ ì „ì†¡
        if: always()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          TOTAL=0
          PASSED=0
          FAILED=0

          if [ -f "qa/reports/daily-report.json" ]; then
            TOTAL=$(python -c "import json; print(json.load(open('qa/reports/daily-report.json')).get('summary',{}).get('total',0))")
            PASSED=$(python -c "import json; print(json.load(open('qa/reports/daily-report.json')).get('summary',{}).get('passed',0))")
            FAILED=$(python -c "import json; print(json.load(open('qa/reports/daily-report.json')).get('summary',{}).get('failed',0))")
          fi

          if [ "$TOTAL" -gt 0 ]; then
            PASS_RATE=$(echo "scale=1; $PASSED * 100 / $TOTAL" | bc)
          else
            PASS_RATE="0.0"
          fi

          if [ $(echo "$PASS_RATE >= 95" | bc -l) -eq 1 ]; then
            COLOR="#36a64f"
            STATUS="PASSED"
          elif [ $(echo "$PASS_RATE >= 80" | bc -l) -eq 1 ]; then
            COLOR="#ffcc00"
            STATUS="WARNING"
          else
            COLOR="#ff0000"
            STATUS="FAILED"
          fi

          TODAY=$(TZ='Asia/Seoul' date '+%Y-%m-%d')
          NOW=$(TZ='Asia/Seoul' date '+%H:%M')

          curl -X POST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json" \
            --data "{
              \"channel\": \"${{ env.SLACK_CHANNEL_ID }}\",
              \"text\": \"QA Daily Report - $TODAY\",
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"blocks\": [
                  {
                    \"type\": \"header\",
                    \"text\": {
                      \"type\": \"plain_text\",
                      \"text\": \"SaveTax QA Daily Report\",
                      \"emoji\": true
                    }
                  },
                  {
                    \"type\": \"section\",
                    \"fields\": [
                      {\"type\": \"mrkdwn\", \"text\": \"*Date:*\n$TODAY\"},
                      {\"type\": \"mrkdwn\", \"text\": \"*Time:*\n$NOW KST\"},
                      {\"type\": \"mrkdwn\", \"text\": \"*Status:*\n$STATUS\"},
                      {\"type\": \"mrkdwn\", \"text\": \"*Pass Rate:*\n${PASS_RATE}%\"}
                    ]
                  },
                  {
                    \"type\": \"section\",
                    \"text\": {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Test Results:*\n- Total: ${TOTAL}\n- Passed: ${PASSED}\n- Failed: ${FAILED}\"
                    }
                  },
                  {
                    \"type\": \"context\",
                    \"elements\": [
                      {\"type\": \"mrkdwn\", \"text\": \"<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>\"}
                    ]
                  }
                ]
              }]
            }"

      - name: ì™„ë£Œ ì‹œê°„ ê¸°ë¡
        if: always()
        run: |
          echo "ğŸ• í…ŒìŠ¤íŠ¸ ì™„ë£Œ: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S') KST"
