name: QA Ï†ïÍ∏∞ ÌÖåÏä§Ìä∏ (Ïò§Ï†Ñ 10Ïãú)

on:
  # ========================================
  # üïô Ïò§Ï†Ñ 10Ïãú Ï†ïÍ∞Å Î¶¨Ìè¨ÌåÖÏùÑ ÏúÑÌïú Ïä§ÏºÄÏ§Ñ
  # ========================================
  # ÌÖåÏä§Ìä∏ Ïã§Ìñâ ÏãúÍ∞Ñ: ÏïΩ 5-10Î∂Ñ
  # 9:50 KST ÏãúÏûë ‚Üí 10:00 KST Î¶¨Ìè¨ÌåÖ ÎèÑÏ∞©
  # 9:50 KST = 0:50 UTC
  schedule:
    - cron: '50 0 * * 1-5'  # ÌèâÏùº Ïò§Ï†Ñ 9:50 KST

  # ÏàòÎèô Ïã§Ìñâ
  workflow_dispatch:
    inputs:
      send_slack:
        description: 'Slack ÏïåÎ¶º Ï†ÑÏÜ°'
        required: false
        default: true
        type: boolean

env:
  QA_BASE_URL: https://qa.hiddenmoney.co.kr
  SLACK_CHANNEL_ID: C0ACQMG41CY

jobs:
  daily-test:
    name: üìÖ ÏùºÏùº QA ÌÖåÏä§Ìä∏
    runs-on: ubuntu-latest

    steps:
      - name: ÏãúÏûë ÏãúÍ∞Ñ Í∏∞Î°ù
        run: |
          echo "üïê ÌÖåÏä§Ìä∏ ÏãúÏûë: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S') KST"

      - name: ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
        uses: actions/checkout@v4

      - name: Python ÏÑ§Ï†ï
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
        run: |
          pip install -r requirements-qa.txt

      - name: Chrome Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ïπò
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: ÌÖåÏä§Ìä∏ ÌôòÍ≤Ω Ï§ÄÎπÑ
        run: |
          mkdir -p qa/reports

      - name: Ï†ÑÏ≤¥ E2E ÌÖåÏä§Ìä∏ Ïã§Ìñâ
        env:
          QA_HEADLESS: 'true'
          PYTHONPATH: ${{ github.workspace }}
        run: |
          cd qa
          python -m pytest tests/ \
            -v \
            --tb=short \
            --html=reports/daily-report.html \
            --self-contained-html \
            --json-report \
            --json-report-file=reports/daily-report.json \
            || true

      - name: ÌÖåÏä§Ìä∏ Í≤∞Í≥º ÏóÖÎ°úÎìú
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: daily-test-${{ github.run_number }}
          path: qa/reports/
          retention-days: 14

      # ========================================
      # Slack Î¶¨Ìè¨Ìä∏ (Bot Token Î∞©Ïãù)
      # ========================================
      - name: Slack ÏùºÏùº Î¶¨Ìè¨Ìä∏ (Bot Token)
        if: always() && secrets.SLACK_BOT_TOKEN != ''
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          TOTAL=0
          PASSED=0
          FAILED=0
          SKIPPED=0

          if [ -f "qa/reports/daily-report.json" ]; then
            TOTAL=$(python -c "import json; print(json.load(open('qa/reports/daily-report.json')).get('summary',{}).get('total',0))")
            PASSED=$(python -c "import json; print(json.load(open('qa/reports/daily-report.json')).get('summary',{}).get('passed',0))")
            FAILED=$(python -c "import json; print(json.load(open('qa/reports/daily-report.json')).get('summary',{}).get('failed',0))")
            SKIPPED=$(python -c "import json; print(json.load(open('qa/reports/daily-report.json')).get('summary',{}).get('skipped',0))")
          fi

          if [ "$TOTAL" -gt 0 ]; then
            PASS_RATE=$(echo "scale=1; $PASSED * 100 / $TOTAL" | bc)
          else
            PASS_RATE="0.0"
          fi

          # ÏÉÅÌÉú Í≤∞Ï†ï
          if [ $(echo "$PASS_RATE >= 95" | bc -l) -eq 1 ]; then
            COLOR="#36a64f"
            EMOJI="‚úÖ"
            STATUS="PASSED"
          elif [ $(echo "$PASS_RATE >= 80" | bc -l) -eq 1 ]; then
            COLOR="#ffcc00"
            EMOJI="‚ö†Ô∏è"
            STATUS="WARNING"
          else
            COLOR="#ff0000"
            EMOJI="‚ùå"
            STATUS="FAILED"
          fi

          TODAY=$(TZ='Asia/Seoul' date '+%Y-%m-%d')
          NOW=$(TZ='Asia/Seoul' date '+%H:%M')

          # Slack APIÎ°ú Î©îÏãúÏßÄ Ï†ÑÏÜ°
          curl -X POST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json" \
            --data "{
              \"channel\": \"${{ env.SLACK_CHANNEL_ID }}\",
              \"text\": \"$EMOJI ÏùºÏùº QA Î¶¨Ìè¨Ìä∏ - $TODAY\",
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"blocks\": [
                  {
                    \"type\": \"header\",
                    \"text\": {
                      \"type\": \"plain_text\",
                      \"text\": \"$EMOJI ÏÑ∏Ïù¥Î∏åÌÉùÏä§ ÏùºÏùº QA Î¶¨Ìè¨Ìä∏\",
                      \"emoji\": true
                    }
                  },
                  {
                    \"type\": \"section\",
                    \"fields\": [
                      {\"type\": \"mrkdwn\", \"text\": \"*ÎÇ†Ïßú:*\n$TODAY\"},
                      {\"type\": \"mrkdwn\", \"text\": \"*ÏãúÍ∞Ñ:*\n$NOW KST\"},
                      {\"type\": \"mrkdwn\", \"text\": \"*ÏÉÅÌÉú:*\n$STATUS\"},
                      {\"type\": \"mrkdwn\", \"text\": \"*ÌÜµÍ≥ºÏú®:*\n${PASS_RATE}%\"}
                    ]
                  },
                  {
                    \"type\": \"divider\"
                  },
                  {
                    \"type\": \"section\",
                    \"text\": {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*üìä ÌÖåÏä§Ìä∏ Í≤∞Í≥º*\n‚Ä¢ Ï†ÑÏ≤¥: ${TOTAL}Í∞ú\n‚Ä¢ ÌÜµÍ≥º: ${PASSED}Í∞ú ‚úì\n‚Ä¢ Ïã§Ìå®: ${FAILED}Í∞ú ‚úó\n‚Ä¢ Ïä§ÌÇµ: ${SKIPPED}Í∞ú\"
                    }
                  },
                  {
                    \"type\": \"context\",
                    \"elements\": [
                      {\"type\": \"mrkdwn\", \"text\": \"<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|üîó GitHub ActionsÏóêÏÑú ÏÉÅÏÑ∏ Î≥¥Í∏∞>\"}
                    ]
                  }
                ]
              }]
            }"

      # ========================================
      # Slack Î¶¨Ìè¨Ìä∏ (Webhook Î∞©Ïãù - ÎåÄÏ≤¥)
      # ========================================
      - name: Slack ÏùºÏùº Î¶¨Ìè¨Ìä∏ (Webhook)
        if: always() && secrets.SLACK_BOT_TOKEN == '' && secrets.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          TOTAL=0
          PASSED=0
          FAILED=0

          if [ -f "qa/reports/daily-report.json" ]; then
            TOTAL=$(python -c "import json; print(json.load(open('qa/reports/daily-report.json')).get('summary',{}).get('total',0))")
            PASSED=$(python -c "import json; print(json.load(open('qa/reports/daily-report.json')).get('summary',{}).get('passed',0))")
            FAILED=$(python -c "import json; print(json.load(open('qa/reports/daily-report.json')).get('summary',{}).get('failed',0))")
          fi

          TODAY=$(TZ='Asia/Seoul' date '+%Y-%m-%d')

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"üìÖ *ÏÑ∏Ïù¥Î∏åÌÉùÏä§ ÏùºÏùº QA Î¶¨Ìè¨Ìä∏* - $TODAY\n‚Ä¢ Ï†ÑÏ≤¥: ${TOTAL}Í∞ú\n‚Ä¢ ÌÜµÍ≥º: ${PASSED}Í∞ú ‚úì\n‚Ä¢ Ïã§Ìå®: ${FAILED}Í∞ú ‚úó\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ÏÉÅÏÑ∏ Î≥¥Í∏∞>\"
            }" \
            $SLACK_WEBHOOK_URL

      - name: ÏôÑÎ£å ÏãúÍ∞Ñ Í∏∞Î°ù
        if: always()
        run: |
          echo "üïê ÌÖåÏä§Ìä∏ ÏôÑÎ£å: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S') KST"
