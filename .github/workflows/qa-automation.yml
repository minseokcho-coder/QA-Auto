name: QA ÏûêÎèôÌôî ÌååÏù¥ÌîÑÎùºÏù∏

on:
  # ÏàòÎèô Ïã§Ìñâ
  workflow_dispatch:
    inputs:
      environment:
        description: 'ÌÖåÏä§Ìä∏ ÌôòÍ≤Ω'
        required: true
        default: 'qa'
        type: choice
        options:
          - qa
          - staging
          - prod
      skip_figma:
        description: 'Figma Ï≤¥ÌÅ¨ Ïä§ÌÇµ'
        required: false
        default: false
        type: boolean
      skip_visual:
        description: 'ÏãúÍ∞ÅÏ†Å ÌÖåÏä§Ìä∏ Ïä§ÌÇµ'
        required: false
        default: false
        type: boolean
      generate_tc:
        description: 'TC ÏûêÎèô ÏÉùÏÑ±'
        required: false
        default: false
        type: boolean

  # Ïä§ÏºÄÏ§Ñ (Îß§Ïùº Ïò§Ï†Ñ 9Ïãú KST = UTC 0Ïãú)
  schedule:
    - cron: '0 0 * * *'

  # PR Ïãú ÏûêÎèô Ïã§Ìñâ
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'qa/**'
      - '.github/workflows/qa-automation.yml'

  # main Î∏åÎûúÏπò push Ïãú
  push:
    branches: [main]
    paths:
      - 'src/**'

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # ========================================
  # 1. Figma Î≥ÄÍ≤Ω Í∞êÏßÄ
  # ========================================
  figma-check:
    name: üìê Figma Î≥ÄÍ≤Ω Í∞êÏßÄ
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_figma != 'true' }}
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
      new_screens: ${{ steps.check.outputs.new_screens }}
      modified_screens: ${{ steps.check.outputs.modified_screens }}

    steps:
      - name: ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
        uses: actions/checkout@v4

      - name: Python ÏÑ§Ï†ï
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
        run: |
          pip install requests python-dotenv

      - name: Figma Î≥ÄÍ≤Ω Í∞êÏßÄ
        id: check
        env:
          FIGMA_ACCESS_TOKEN: ${{ secrets.FIGMA_ACCESS_TOKEN }}
          FIGMA_FILE_KEY: ${{ secrets.FIGMA_FILE_KEY }}
          FIGMA_NODE_ID: ${{ secrets.FIGMA_NODE_ID }}
        run: |
          python -c "
          import os
          import json
          import requests

          token = os.environ.get('FIGMA_ACCESS_TOKEN')
          file_key = os.environ.get('FIGMA_FILE_KEY', 'rcxhAYTksM5DmkrjqTuvHc')
          node_id = os.environ.get('FIGMA_NODE_ID', '9987-46608')

          if not token:
              print('FIGMA_ACCESS_TOKEN not set, skipping...')
              print('has_changes=false' )
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write('has_changes=false\n')
              exit(0)

          headers = {'X-Figma-Token': token}
          url = f'https://api.figma.com/v1/files/{file_key}/nodes?ids={node_id}'

          try:
              response = requests.get(url, headers=headers)
              response.raise_for_status()
              data = response.json()
              print(f'Figma API Ìò∏Ï∂ú ÏÑ±Í≥µ: {data.get(\"name\", \"Unknown\")}')
              print(f'ÎßàÏßÄÎßâ ÏàòÏ†ï: {data.get(\"lastModified\", \"Unknown\")}')

              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write('has_changes=true\n')
                  f.write('new_screens=[]\n')
                  f.write('modified_screens=[]\n')
          except Exception as e:
              print(f'Figma API Ïò§Î•ò: {e}')
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write('has_changes=false\n')
          "

      - name: Î≥ÄÍ≤Ω ÏÇ¨Ìï≠ ÏöîÏïΩ
        if: steps.check.outputs.has_changes == 'true'
        run: |
          echo "üé® Figma ÎîîÏûêÏù∏ Î≥ÄÍ≤Ω Í∞êÏßÄÎê®"
          echo "ÏÉà ÌôîÎ©¥: ${{ steps.check.outputs.new_screens }}"
          echo "ÏàòÏ†ïÎêú ÌôîÎ©¥: ${{ steps.check.outputs.modified_screens }}"

  # ========================================
  # 2. E2E ÌÖåÏä§Ìä∏
  # ========================================
  e2e-test:
    name: üß™ E2E ÌÖåÏä§Ìä∏
    runs-on: ubuntu-latest
    needs: [figma-check]
    if: always()

    steps:
      - name: ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
        uses: actions/checkout@v4

      - name: Python ÏÑ§Ï†ï
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
        run: |
          pip install -r requirements-qa.txt

      - name: Chrome Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ïπò
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: ÌÖåÏä§Ìä∏ ÌôòÍ≤Ω Ï§ÄÎπÑ
        run: |
          mkdir -p qa/reports

      - name: ÌÖåÏä§Ìä∏ ÌôòÍ≤Ω URL ÏÑ§Ï†ï
        id: env-url
        run: |
          ENV="${{ github.event.inputs.environment || 'qa' }}"
          case $ENV in
            qa)
              echo "url=https://qa.hiddenmoney.co.kr" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "url=https://staging.hiddenmoney.co.kr" >> $GITHUB_OUTPUT
              ;;
            prod)
              echo "url=https://www.hiddenmoney.co.kr" >> $GITHUB_OUTPUT
              ;;
          esac
          echo "ÌôòÍ≤Ω: $ENV"

      - name: E2E ÌÖåÏä§Ìä∏ Ïã§Ìñâ
        env:
          QA_BASE_URL: ${{ steps.env-url.outputs.url }}
          QA_HEADLESS: 'true'
          PYTHONPATH: ${{ github.workspace }}
        run: |
          cd qa
          python -m pytest tests/ \
            -v \
            --tb=short \
            --html=reports/e2e-report.html \
            --self-contained-html \
            --json-report \
            --json-report-file=reports/e2e-report.json \
            || true

      - name: ÌÖåÏä§Ìä∏ Í≤∞Í≥º ÏóÖÎ°úÎìú
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            qa/reports/e2e-report.html
            qa/reports/e2e-report.json
            qa/reports/screenshots/
          retention-days: 30

      - name: ÌÖåÏä§Ìä∏ Í≤∞Í≥º ÏöîÏïΩ
        if: always()
        run: |
          if [ -f qa/reports/e2e-report.json ]; then
            python -c "
          import json
          with open('qa/reports/e2e-report.json') as f:
              data = json.load(f)
          summary = data.get('summary', {})
          print('üìä E2E ÌÖåÏä§Ìä∏ Í≤∞Í≥º')
          print(f'  Ï†ÑÏ≤¥: {summary.get(\"total\", 0)}')
          print(f'  ÌÜµÍ≥º: {summary.get(\"passed\", 0)}')
          print(f'  Ïã§Ìå®: {summary.get(\"failed\", 0)}')
          print(f'  Ïä§ÌÇµ: {summary.get(\"skipped\", 0)}')
            "
          fi

  # ========================================
  # 3. ÏãúÍ∞ÅÏ†Å ÌöåÍ∑Ä ÌÖåÏä§Ìä∏
  # ========================================
  visual-test:
    name: üëÅÔ∏è ÏãúÍ∞ÅÏ†Å ÌöåÍ∑Ä ÌÖåÏä§Ìä∏
    runs-on: ubuntu-latest
    needs: [e2e-test]
    if: ${{ github.event.inputs.skip_visual != 'true' && always() }}

    steps:
      - name: ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
        uses: actions/checkout@v4

      - name: Python ÏÑ§Ï†ï
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
        run: |
          pip install playwright Pillow numpy requests

      - name: Playwright ÏÑ§Ïπò
        run: |
          playwright install chromium
          playwright install-deps chromium

      - name: Î≤†Ïù¥Ïä§ÎùºÏù∏ Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú
        uses: actions/cache@v4
        with:
          path: qa/reports/visual/baseline
          key: visual-baseline-${{ github.ref_name }}
          restore-keys: |
            visual-baseline-main
            visual-baseline-

      - name: Ïä§ÌÅ¨Î¶∞ÏÉ∑ Ï∫°Ï≤ò
        env:
          QA_BASE_URL: ${{ needs.e2e-test.outputs.url || 'https://qa.hiddenmoney.co.kr' }}
        run: |
          python -c "
          import asyncio
          from pathlib import Path

          # Í∞ÑÎã®Ìïú Ïä§ÌÅ¨Î¶∞ÏÉ∑ Ï∫°Ï≤ò
          async def capture():
              from playwright.async_api import async_playwright

              actual_dir = Path('qa/reports/visual/actual')
              actual_dir.mkdir(parents=True, exist_ok=True)

              async with async_playwright() as p:
                  browser = await p.chromium.launch(headless=True)
                  context = await browser.new_context(
                      viewport={'width': 375, 'height': 667},
                      locale='ko-KR'
                  )
                  page = await context.new_page()

                  try:
                      await page.goto('${{ env.QA_BASE_URL }}', wait_until='networkidle')
                      await page.wait_for_timeout(2000)
                      await page.screenshot(path=str(actual_dir / 'home.png'), full_page=True)
                      print('‚úì Ìôà ÌôîÎ©¥ Ïä§ÌÅ¨Î¶∞ÏÉ∑ Ï∫°Ï≤ò ÏôÑÎ£å')
                  except Exception as e:
                      print(f'Ïä§ÌÅ¨Î¶∞ÏÉ∑ Ï∫°Ï≤ò Ïã§Ìå®: {e}')

                  await browser.close()

          asyncio.run(capture())
          "

      - name: ÏãúÍ∞ÅÏ†Å ÎπÑÍµê Ïã§Ìñâ
        run: |
          python -c "
          from pathlib import Path
          from PIL import Image, ImageChops
          import numpy as np

          baseline_dir = Path('qa/reports/visual/baseline')
          actual_dir = Path('qa/reports/visual/actual')
          diff_dir = Path('qa/reports/visual/diff')
          diff_dir.mkdir(parents=True, exist_ok=True)

          results = []
          for actual_path in actual_dir.glob('*.png'):
              baseline_path = baseline_dir / actual_path.name

              if not baseline_path.exists():
                  print(f'‚ö†Ô∏è Î≤†Ïù¥Ïä§ÎùºÏù∏ ÏóÜÏùå: {actual_path.name}')
                  # Ï≤´ Ïã§Ìñâ Ïãú Î≤†Ïù¥Ïä§ÎùºÏù∏ÏúºÎ°ú Î≥µÏÇ¨
                  baseline_dir.mkdir(parents=True, exist_ok=True)
                  import shutil
                  shutil.copy(actual_path, baseline_path)
                  results.append({'name': actual_path.name, 'status': 'NEW'})
                  continue

              try:
                  baseline = Image.open(baseline_path).convert('RGB')
                  actual = Image.open(actual_path).convert('RGB')

                  if baseline.size != actual.size:
                      actual = actual.resize(baseline.size, Image.Resampling.LANCZOS)

                  diff = ImageChops.difference(baseline, actual)
                  diff_array = np.array(diff)
                  diff_pixels = np.sum(np.sum(diff_array, axis=2) > 30)
                  total_pixels = diff_array.shape[0] * diff_array.shape[1]
                  diff_pct = (diff_pixels / total_pixels) * 100

                  status = '‚úì MATCH' if diff_pct < 0.1 else f'‚úó DIFF ({diff_pct:.2f}%)'
                  print(f'{status}: {actual_path.name}')

                  if diff_pct >= 0.1:
                      diff.save(diff_dir / f'{actual_path.stem}_diff.png')

                  results.append({'name': actual_path.name, 'diff_pct': diff_pct})
              except Exception as e:
                  print(f'ÎπÑÍµê Ïò§Î•ò ({actual_path.name}): {e}')
          "

      - name: Î≤†Ïù¥Ïä§ÎùºÏù∏ ÏóÖÎç∞Ïù¥Ìä∏ (main Î∏åÎûúÏπò)
        if: github.ref == 'refs/heads/main'
        run: |
          cp -r qa/reports/visual/actual/* qa/reports/visual/baseline/ 2>/dev/null || true

      - name: ÏãúÍ∞ÅÏ†Å ÌÖåÏä§Ìä∏ Í≤∞Í≥º ÏóÖÎ°úÎìú
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-test-results
          path: qa/reports/visual/
          retention-days: 30

  # ========================================
  # 4. Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ± Î∞è ÏïåÎ¶º
  # ========================================
  report:
    name: üìä Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±
    runs-on: ubuntu-latest
    needs: [figma-check, e2e-test, visual-test]
    if: always()

    steps:
      - name: ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
        uses: actions/checkout@v4

      - name: Python ÏÑ§Ï†ï
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
        run: |
          pip install openpyxl pandas requests

      - name: ÌÖåÏä§Ìä∏ Í≤∞Í≥º Îã§Ïö¥Î°úÎìú
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: ÏóëÏÖÄ Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±
        run: |
          python -c "
          import json
          from pathlib import Path
          from datetime import datetime
          from openpyxl import Workbook
          from openpyxl.styles import Font, PatternFill, Alignment

          # Í≤∞Í≥º ÏàòÏßë
          e2e_report = Path('artifacts/e2e-test-results/e2e-report.json')

          total = passed = failed = skipped = 0
          if e2e_report.exists():
              with open(e2e_report) as f:
                  data = json.load(f)
              summary = data.get('summary', {})
              total = summary.get('total', 0)
              passed = summary.get('passed', 0)
              failed = summary.get('failed', 0)
              skipped = summary.get('skipped', 0)

          pass_rate = (passed / total * 100) if total > 0 else 0

          # ÏóëÏÖÄ ÏÉùÏÑ±
          wb = Workbook()
          ws = wb.active
          ws.title = 'ÏöîÏïΩ'

          ws['A1'] = 'QA ÏûêÎèôÌôî Î¶¨Ìè¨Ìä∏'
          ws['A1'].font = Font(bold=True, size=14)

          data = [
              ['', ''],
              ['ÌôòÍ≤Ω', '${{ github.event.inputs.environment || \"qa\" }}'],
              ['Ïã§Ìñâ ÏãúÍ∞Ñ', datetime.now().strftime('%Y-%m-%d %H:%M:%S')],
              ['Ìä∏Î¶¨Í±∞', '${{ github.event_name }}'],
              ['Î∏åÎûúÏπò', '${{ github.ref_name }}'],
              ['', ''],
              ['ÌÖåÏä§Ìä∏ Í≤∞Í≥º', ''],
              ['Ï†ÑÏ≤¥', total],
              ['ÌÜµÍ≥º', passed],
              ['Ïã§Ìå®', failed],
              ['Ïä§ÌÇµ', skipped],
              ['ÌÜµÍ≥ºÏú®', f'{pass_rate:.1f}%'],
          ]

          for row_idx, (label, value) in enumerate(data, 2):
              ws.cell(row=row_idx, column=1, value=label)
              ws.cell(row=row_idx, column=2, value=value)

          # ÌÜµÍ≥ºÏú® ÏÉâÏÉÅ
          if pass_rate >= 95:
              fill = PatternFill(start_color='C6EFCE', end_color='C6EFCE', fill_type='solid')
          elif pass_rate >= 80:
              fill = PatternFill(start_color='FFEB9C', end_color='FFEB9C', fill_type='solid')
          else:
              fill = PatternFill(start_color='FF6B6B', end_color='FF6B6B', fill_type='solid')
          ws.cell(row=13, column=2).fill = fill

          ws.column_dimensions['A'].width = 15
          ws.column_dimensions['B'].width = 30

          # Ï†ÄÏû•
          Path('qa/reports').mkdir(parents=True, exist_ok=True)
          filepath = f'qa/reports/QA_Report_{datetime.now().strftime(\"%Y%m%d_%H%M%S\")}.xlsx'
          wb.save(filepath)
          print(f'ÏóëÏÖÄ Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±: {filepath}')
          "

      - name: Slack ÏïåÎ¶º Ï†ÑÏÜ°
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Í≤∞Í≥º ÌååÏã±
          TOTAL=0
          PASSED=0
          FAILED=0

          if [ -f "artifacts/e2e-test-results/e2e-report.json" ]; then
            TOTAL=$(cat artifacts/e2e-test-results/e2e-report.json | python -c "import sys,json; print(json.load(sys.stdin).get('summary',{}).get('total',0))")
            PASSED=$(cat artifacts/e2e-test-results/e2e-report.json | python -c "import sys,json; print(json.load(sys.stdin).get('summary',{}).get('passed',0))")
            FAILED=$(cat artifacts/e2e-test-results/e2e-report.json | python -c "import sys,json; print(json.load(sys.stdin).get('summary',{}).get('failed',0))")
          fi

          if [ "$TOTAL" -gt 0 ]; then
            PASS_RATE=$(echo "scale=1; $PASSED * 100 / $TOTAL" | bc)
          else
            PASS_RATE="0.0"
          fi

          # ÏÉÅÌÉúÏóê Îî∞Î•∏ ÏÉâÏÉÅ
          if [ $(echo "$PASS_RATE >= 95" | bc -l) -eq 1 ]; then
            COLOR="good"
            EMOJI="‚úÖ"
            STATUS="PASSED"
          elif [ $(echo "$PASS_RATE >= 80" | bc -l) -eq 1 ]; then
            COLOR="warning"
            EMOJI="‚ö†Ô∏è"
            STATUS="WARNING"
          else
            COLOR="danger"
            EMOJI="‚ùå"
            STATUS="FAILED"
          fi

          # Slack Î©îÏãúÏßÄ Ï†ÑÏÜ°
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"blocks\": [
                  {
                    \"type\": \"header\",
                    \"text\": {
                      \"type\": \"plain_text\",
                      \"text\": \"$EMOJI QA ÏûêÎèôÌôî Î¶¨Ìè¨Ìä∏\",
                      \"emoji\": true
                    }
                  },
                  {
                    \"type\": \"section\",
                    \"fields\": [
                      {\"type\": \"mrkdwn\", \"text\": \"*ÌôòÍ≤Ω:*\n${{ github.event.inputs.environment || 'qa' }}\"},
                      {\"type\": \"mrkdwn\", \"text\": \"*ÏÉÅÌÉú:*\n$STATUS\"},
                      {\"type\": \"mrkdwn\", \"text\": \"*ÌÜµÍ≥ºÏú®:*\n${PASS_RATE}%\"},
                      {\"type\": \"mrkdwn\", \"text\": \"*Î∏åÎûúÏπò:*\n${{ github.ref_name }}\"}
                    ]
                  },
                  {
                    \"type\": \"section\",
                    \"text\": {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*ÌÖåÏä§Ìä∏ Í≤∞Í≥º:*\n‚Ä¢ Ï†ÑÏ≤¥: ${TOTAL}Í∞ú\n‚Ä¢ ÌÜµÍ≥º: ${PASSED}Í∞ú ‚úì\n‚Ä¢ Ïã§Ìå®: ${FAILED}Í∞ú ‚úó\"
                    }
                  },
                  {
                    \"type\": \"context\",
                    \"elements\": [
                      {\"type\": \"mrkdwn\", \"text\": \"<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub ActionsÏóêÏÑú ÏÉÅÏÑ∏ Î≥¥Í∏∞>\"}
                    ]
                  }
                ]
              }]
            }" \
            $SLACK_WEBHOOK_URL

      - name: Î¶¨Ìè¨Ìä∏ ÏóÖÎ°úÎìú
        uses: actions/upload-artifact@v4
        with:
          name: qa-report
          path: qa/reports/*.xlsx
          retention-days: 90

      - name: Job ÏöîÏïΩ
        run: |
          echo "## üìä QA ÏûêÎèôÌôî Í≤∞Í≥º" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ìï≠Î™© | Í≤∞Í≥º |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ÌôòÍ≤Ω | ${{ github.event.inputs.environment || 'qa' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Î∏åÎûúÏπò | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Figma Î≥ÄÍ≤Ω | ${{ needs.figma-check.outputs.has_changes || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ÏÉÅÏÑ∏ Í≤∞Í≥ºÎäî ArtifactsÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî." >> $GITHUB_STEP_SUMMARY
