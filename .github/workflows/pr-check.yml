name: PR ì²´í¬

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

jobs:
  lint-and-test:
    name: ğŸ” ì½”ë“œ ê²€ì¦
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          pip install -r requirements-qa.txt

      - name: ì½”ë“œ ë¬¸ë²• ê²€ì‚¬
        run: |
          pip install flake8
          flake8 qa/ --count --select=E9,F63,F7,F82 --show-source --statistics || true

      - name: ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        env:
          QA_BASE_URL: https://qa.hiddenmoney.co.kr
          QA_HEADLESS: 'true'
        run: |
          cd qa
          python -m pytest tests/test_home.py -v --tb=short || true

  smoke-test:
    name: ğŸš€ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: lint-and-test

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          pip install requests

      - name: ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
        run: |
          python -c "
          import requests

          urls = [
              'https://qa.hiddenmoney.co.kr',
          ]

          for url in urls:
              try:
                  response = requests.get(url, timeout=10)
                  status = 'âœ“' if response.status_code == 200 else 'âœ—'
                  print(f'{status} {url} - {response.status_code}')
              except Exception as e:
                  print(f'âœ— {url} - {e}')
          "

      - name: PR ì½”ë©˜íŠ¸
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… QA ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì™„ë£Œ\n\nìƒì„¸ ê²°ê³¼ëŠ” [Actions](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ')ì—ì„œ í™•ì¸í•˜ì„¸ìš”.'
            })
